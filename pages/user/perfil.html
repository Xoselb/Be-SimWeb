<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/assets/images/EB.png" type="image/png">
    <title>Mon Profil - EB Simracing</title>
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' http://localhost:3000;">
    
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/user/perfil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/assets/styles/all.min.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <a href="../../index.html"><img src="/assets/images/EB SIMRACING(Solo-White).png" alt="EB Simracing" class="logo-img"></a>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="../../index.html#inicio">Accueil</a></li>
                    <li><a href="../../index.html#servicios">Services</a></li>
                    <li><a href="../info/galerie.html">Galerie</a></li>
                    <li><a href="../shop/merch.html">Boutique</a></li>
                    <li><a href="../info/contacto.html">Contact</a></li>
                    <li class="nav-user" id="navUser" style="display: none;">
                        <div class="user-avatar" id="userMenuBtn">
                            <img src="/assets/images/default-avatar.png" alt="Profil" id="userAvatar">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="user-dropdown" id="userDropdown">
                            <a href="../auth/perfil.html" class="active"><i class="fas fa-user"></i> Mon Profil</a>
                            <a href="mes-reservations.html"><i class="fas fa-calendar-alt"></i> Mes réservations</a>
                            <a href="parametres.html"><i class="fas fa-cog"></i> Paramètres</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a>
                        </div>
                    </li>
                    <li class="nav-login" id="navLogin">
                        <a href="../auth/login.html" class="btn-login">Connexion</a>
                    </li>
                </ul>
            </nav>
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </header>

    <main class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar">
                <img src="/assets/images/default-avatar.png" alt="Photo de profil" id="profileAvatar">
                <label for="avatarUpload" class="avatar-upload">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                </label>
            </div>
            <h1 id="profileName">Nom d'utilisateur</h1>
            <p id="profileEmail">email@example.com</p>
            <div class="user-role" id="userRole">
                <span class="role-badge">Rôle</span>
            </div>
        </div>

        <div class="profile-content">
            <div class="profile-section">
                <h2>Informations personnelles</h2>
                <form id="profileForm">
                    <div class="form-group">
                        <label for="firstName">Prénom</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Nom</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Téléphone</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                    <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                </form>
            </div>

            <div class="profile-section">
                <h2>Changer le mot de passe</h2>
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="currentPassword">Mot de passe actuel</label>
                        <input type="password" id="currentPassword" name="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Nouveau mot de passe</label>
                        <input type="password" id="newPassword" name="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirmer le nouveau mot de passe</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Changer le mot de passe</button>
                </form>
            </div>
        </div>
    </main>

    <script src="/assets/scripts/auth.js"></script>
    <script src="/assets/scripts/perfil.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu functionality
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const mainNav = document.querySelector('.main-nav');
            
            if (mobileMenuBtn && mainNav) {
                mobileMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    mainNav.classList.toggle('show');
                });
                
                // Close mobile menu when clicking on a nav link
                const navLinks = mainNav.querySelectorAll('a');
                navLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        mainNav.classList.remove('show');
                    });
                });
                
                // Close mobile menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (!mainNav.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                        mainNav.classList.remove('show');
                    }
                });
            }
            // Verificar autenticación y cargar datos del usuario
            if (!window.auth.isAuthenticated()) {
                window.location.href = 'pages/auth/login.html';
                return;
            }

            // Mostrar/ocultar elementos según autenticación
            const navUser = document.getElementById('navUser');
            const navLogin = document.getElementById('navLogin');
            
            if (navUser) navUser.style.display = 'block';
            if (navLogin) navLogin.style.display = 'none';
            
            // Cargar datos del usuario
            function loadUserData() {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (userData) {
                    document.getElementById('profileName').textContent = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Utilisateur';
                    document.getElementById('profileEmail').textContent = userData.email || 'email@example.com';
                    document.getElementById('firstName').value = userData.firstName || '';
                    document.getElementById('lastName').value = userData.lastName || '';
                    document.getElementById('email').value = userData.email || '';
                    document.getElementById('phone').value = userData.phone || '';
                    
                    // Mostrar el rol del usuario en francés
                    const roleElement = document.getElementById('userRole');
                    if (roleElement) {
                        // Mapeo de roles a sus versiones en francés
                        const roleMap = {
                            'propriétaire': 'Propriétaire',
                            'modérateur': 'Developer',
                            'administrateur': 'Administrateur',
                            'premium': 'Membre Premium',
                            'utilisateur': 'Utilisateur',
                            // Mantener compatibilidad con roles antiguos
                            'dueño': 'Propriétaire',
                            'dev': 'Developer',  // Cambiado de 'Modérateur' a 'Developer' para consistencia
                            'admin': 'Administrateur',
                            'vip': 'Membre Premium',
                            'usuario': 'Utilisateur'
                        };
                        
                        const role = userData.role || 'utilisateur';
                        // Mapeo consistente de roles a clases CSS
                        const roleClass = role === 'propriétaire' ? 'dueño' : 
                                        (role === 'modérateur' || role === 'dev') ? 'dev' :
                                        role === 'administrateur' ? 'admin' :
                                        role === 'premium' ? 'vip' : 'usuario';
                        
                        // Usar el mapeo de roles para el texto mostrado
                        const roleText = roleMap[role] || 'Utilisateur';
                        roleElement.innerHTML = `<span class="role-badge role-${roleClass}">${roleText}</span>`;
                    }
                    
                    if (userData.avatar) {
                        document.getElementById('profileAvatar').src = userData.avatar;
                        document.getElementById('userAvatar').src = userData.avatar;
                    }
                }
            }
            loadUserData();
            
            // Manejar la subida de avatar
            document.getElementById('avatarUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const avatarUrl = event.target.result;
                        document.getElementById('profileAvatar').src = avatarUrl;
                        document.getElementById('userAvatar').src = avatarUrl;
                        
                        // Actualizar la imagen en el localStorage
                        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                        userData.avatar = avatarUrl;
                        localStorage.setItem('userData', JSON.stringify(userData));
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Manejar el envío del formulario de perfil
            document.getElementById('profileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Obtener los valores del formulario
                const userData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    avatar: document.getElementById('profileAvatar').src
                };
                
                // Actualizar los datos en el localStorage
                localStorage.setItem('userData', JSON.stringify(userData));
                
                // Actualizar la información en el header
                document.getElementById('profileName').textContent = 
                    (userData.firstName || '') + ' ' + (userData.lastName || '');
                document.getElementById('profileEmail').textContent = userData.email || '';
                document.getElementById('userAvatar').src = userData.avatar;
                
                alert('Modifications enregistrées avec succès!');
            });
            
            // Manejar el cambio de contraseña
            document.getElementById('passwordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    alert('Les mots de passe ne correspondent pas');
                    return;
                }
                
                // Aquí iría la lógica para cambiar la contraseña en el servidor
                alert('Mot de passe modifié avec succès!');
                this.reset();
            });
            
            // Configurar el menú de usuario desplegable
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('show');
                    
                    // Rotar la flecha
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.style.transform = userDropdown.classList.contains('show') 
                            ? 'rotate(180deg)' 
                            : 'rotate(0deg)';
                    }
                });
                
                // Cerrar el menú al hacer clic fuera
                document.addEventListener('click', function() {
                    userDropdown.classList.remove('show');
                    const icon = userMenuBtn.querySelector('i');
                    if (icon) {
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
                
                // Evitar que el menú se cierre al hacer clic dentro
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                // Manejar el logout
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (window.auth && window.auth.logout) {
                            window.auth.logout();
                        } else {
                            window.location.href = 'pages/auth/login.html';
                        }
                    });
                }
            }
        });
    </script>
    
    <!-- Sistema de seguridad -->
    <script src="/assets/scripts/security.js"></script>
    <script src="/assets/scripts/auth.js"></script>
    <script src="/assets/scripts/perfil.js"></script>
</body>
</html>