<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finaliser la Commande - EB Simracing</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/checkout.css">
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="container">
        <div class="nav-container">
            <div class="logo">
                <a href="index.html"><img src="/public/img/EB SIMRACING(Solo-White).png" alt="EB Simracing"></a>
            </div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html#inicio">Accueil</a></li>
                    <li><a href="index.html#servicios">Services</a></li>
                    <li><a href="index.html#simuladores">Simulateurs</a></li>
                    <li><a href="merch.html">Boutique</a></li>
                    <li><a href="index.html#contacto">Contact</a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>

<main class="checkout-container">
    <div class="page-header">
        <h1>Finaliser la Commande</h1>
        <p>Veuillez compléter vos informations pour finaliser votre achat</p>
    </div>

    <div class="checkout-grid">
        <!-- Información del cliente -->
        <div class="checkout-section">
            <h2 class="section-title">
                <i class="fas fa-user"></i>
                Informations de livraison
            </h2>
            
            <form id="checkout-form">
                <div class="form-group">
                    <label for="firstName">Prénom *</label>
                    <input type="text" id="firstName" name="firstName" required>
                </div>
                
                <div class="form-group">
                    <label for="lastName">Nom *</label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Téléphone *</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
                
                <div class="form-group">
                    <label for="address">Adresse *</label>
                    <input type="text" id="address" name="address" required>
                </div>
                
                <div class="form-group">
                    <label for="city">Ville *</label>
                    <input type="text" id="city" name="city" required>
                </div>
                
                <div class="form-group">
                    <label for="postalCode">Code Postal *</label>
                    <input type="text" id="postalCode" name="postalCode" required>
                </div>
                
                <div class="form-group">
                    <label for="country">Pays *</label>
                    <select id="country" name="country" required>
                        <option value="">Sélectionner un pays</option>
                        <option value="BE">Belgique</option>
                        <option value="FR">France</option>
                        <option value="NL">Pays-Bas</option>
                        <option value="LU">Luxembourg</option>
                        <option value="DE">Allemagne</option>
                    </select>
                </div>
            </form>
        </div>

        <!-- Resumen del pedido -->
        <div class="checkout-section">
            <h2 class="section-title">
                <i class="fas fa-shopping-bag"></i>
                Total de la commande
            </h2>
            
            <div class="cart-items" id="cart-items">
                <!-- Los items del carrito se cargarán aquí -->
            </div>
            
            <!-- Total del carrito -->
            <div class="cart-total" id="cart-total">
                <div class="total-row">
                    <span>Sous-total:</span>
                    <span id="subtotal">0.00 €</span>
                </div>
                <div class="total-row">
                    <span>Livraison:</span>
                    <span id="shipping">Gratuite</span>
                </div>
                <div class="total-row total-final">
                    <span>Total:</span>
                    <span id="total-amount">Total: 0.00 €</span>
                </div>
            </div>
            
            <!-- Métodos de pago -->
            <div class="payment-methods">
                <button class="payment-button paypal-button" id="paypal-button">
                    <i class="fab fa-paypal"></i>
                    Payer avec PayPal
                </button>
                
                <button class="payment-button bancontact-button" id="bancontact-button">
                    <i class="fas fa-credit-card"></i>
                    Payer avec Bancontact
                    <div class="coming-soon-overlay">Bientôt disponible</div>
                </button>
                
                <button class="payment-button card-button" id="card-button">
                    <i class="fab fa-cc-visa"></i>
                    Payer avec Visa/Mastercard
                    <div class="coming-soon-overlay">Bientôt disponible</div>
                </button>
            </div>
        </div>
    </div>
</main>

<!-- Scripts -->
<script src="js/services/cartService.js"></script>
<script src="js/cart.js"></script>
<script src="js/auth.js"></script>
<script src="js/header.js"></script>
<script src="js/paymentService.js"></script>
<script>
    // Sistema de Checkout - Funcionalidad Principal
    class CheckoutSystem {
        constructor() {
            this.cartService = null;
            this.authService = null;
            this.paymentService = null;
            this.init();
        }

        async init() {
            // Esperar a que todos los servicios estén disponibles
            await this.waitForServices();
            
            // Inicializar el sistema
            this.loadCart();
            this.setupEventListeners();
            this.checkAuthentication();
        }

        async waitForServices() {
            const maxAttempts = 50;
            let attempts = 0;

            while (attempts < maxAttempts) {
                if (window.cartService && window.auth && window.paymentService) {
                    this.cartService = window.cartService;
                    this.authService = window.auth;
                    this.paymentService = window.paymentService;
                    console.log('Todos los servicios están disponibles');
                    return;
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            throw new Error('No se pudieron cargar los servicios necesarios');
        }

        loadCart() {
            console.log('=== LOAD CART START ===');
            
            // Forzar carga del carrito desde localStorage
            if (this.cartService) {
                this.cartService.loadCartFromStorage();
                
                const cart = this.cartService.cart;
                console.log('Carrito cargado:', cart);
                console.log('Longitud del carrito:', cart.length);
                
                // Si el carrito está vacío, intentar cargar directamente desde localStorage
                if (cart.length === 0) {
                    console.log('Carrito vacío, intentando cargar directamente desde localStorage...');
                    const user = this.authService ? this.authService.getCurrentUser() : null;
                    const cartKey = user ? `cart_${user.id}` : 'guest_cart';
                    const savedCart = localStorage.getItem(cartKey);
                    
                    if (savedCart) {
                        try {
                            const parsedCart = JSON.parse(savedCart);
                            console.log('Carrito encontrado en localStorage:', parsedCart);
                            
                            // Asignar directamente al carrito del servicio
                            this.cartService.cart = parsedCart;
                            console.log('Carrito asignado manualmente:', this.cartService.cart);
                        } catch (error) {
                            console.error('Error parseando carrito:', error);
                        }
                    }
                }
                
                // Actualizar UI con el carrito final
                this.updateCartDisplay(this.cartService.cart);
            } else {
                console.error('CartService no está disponible');
            }
        }

        updateCartDisplay(cart) {
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');
            
            if (!cartItems) return;

            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Votre panier est vide</h3>
                        <p>Ajoutez des produits à votre panier pour continuer</p>
                        <a href="merch.html" class="btn-primary">
                            <i class="fas fa-shopping-bag"></i>
                            Continuer vos achats
                        </a>
                    </div>
                `;
                
                // Ocultar total y métodos de pago
                if (cartTotal) cartTotal.style.display = 'none';
                document.querySelector('.payment-methods').style.display = 'none';
                return;
            }

            // Mostrar items del carrito
            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <img src="${item.image || '/public/img/default-product.png'}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-options">
                            ${item.size ? `Taille: ${item.size}` : ''}
                            ${item.color ? ` | Couleur: ${item.color}` : ''}
                            | Quantité: ${item.quantity}
                        </div>
                        <div class="cart-item-price">${(item.price * item.quantity).toFixed(2)} €</div>
                    </div>
                </div>
            `).join('');

            // Calcular y mostrar totales
            if (cartTotal) {
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const shipping = subtotal > 50 ? 0 : subtotal > 0 ? 5.99 : 0;
                const total = subtotal + shipping;

                document.getElementById('subtotal').textContent = `${subtotal.toFixed(2)} €`;
                document.getElementById('shipping').textContent = shipping === 0 ? 'Gratuite' : `${shipping.toFixed(2)} €`;
                document.getElementById('total-amount').textContent = `${total.toFixed(2)} €`;
                
                cartTotal.style.display = 'block';
            }

            // Mostrar métodos de pago
            document.querySelector('.payment-methods').style.display = 'flex';
        }

        setupEventListeners() {
            // PayPal button
            const paypalBtn = document.getElementById('paypal-button');
            if (paypalBtn) {
                paypalBtn.addEventListener('click', () => this.handlePayPalPayment());
            }

            // Bancontact button
            const bancontactBtn = document.getElementById('bancontact-button');
            if (bancontactBtn) {
                bancontactBtn.addEventListener('click', () => this.handleComingSoon('Bancontact'));
            }

            // Card button
            const cardBtn = document.getElementById('card-button');
            if (cardBtn) {
                cardBtn.addEventListener('click', () => this.handleComingSoon('Carte bancaire'));
            }
        }

        checkAuthentication() {
            if (this.authService.isAuthenticated()) {
                const userData = this.authService.getUserData();
                if (userData) {
                    this.prefillForm(userData);
                }
            }
        }

        prefillForm(userData) {
            const fields = {
                firstName: userData.firstName || userData.name?.split(' ')[0],
                lastName: userData.lastName || userData.name?.split(' ')[1],
                email: userData.email,
                phone: userData.phone
            };

            Object.entries(fields).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element && value) {
                    element.value = value;
                }
            });

            // Prefill address if available
            if (userData.address) {
                const addressField = document.getElementById('address');
                const cityField = document.getElementById('city');
                const postalCodeField = document.getElementById('postalCode');
                const countryField = document.getElementById('country');

                if (userData.address.street && addressField) addressField.value = userData.address.street;
                if (userData.address.city && cityField) cityField.value = userData.address.city;
                if (userData.address.postalCode && postalCodeField) postalCodeField.value = userData.address.postalCode;
                if (userData.address.country && countryField) countryField.value = userData.address.country;
            }
        }

        validateForm() {
            const requiredFields = ['firstName', 'lastName', 'email', 'phone', 'address', 'city', 'postalCode', 'country'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field || !field.value.trim()) {
                    this.showNotification(`Veuillez remplir le champ ${fieldId}`, 'error');
                    if (field) field.focus();
                    return false;
                }
            }

            // Validar email
            const emailField = document.getElementById('email');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailField.value)) {
                this.showNotification('Veuillez entrer une adresse email valide', 'error');
                emailField.focus();
                return false;
            }

            return true;
        }

        async handlePayPalPayment() {
            if (!this.validateForm()) return;

            try {
                const customerInfo = this.getCustomerInfo();
                const cart = this.cartService.cart;
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                const orderData = {
                    orderId: 'order_' + Date.now(),
                    customerInfo,
                    items: cart,
                    total,
                    method: 'paypal'
                };

                // Procesar pago con PayPal
                const result = await this.paymentService.processPayPalPayment(orderData);
                
                if (result.success) {
                    this.showNotification('Paiement PayPal traité avec succès!', 'success');
                    this.clearCartAndRedirect(orderData.orderId, 'paypal');
                } else {
                    this.showNotification(result.error || 'Erreur lors du paiement PayPal', 'error');
                }

            } catch (error) {
                console.error('Error procesando pago PayPal:', error);
                this.showNotification('Erreur lors du traitement du paiement PayPal', 'error');
            }
        }

        handleComingSoon(method) {
            this.showNotification(`Paiement par ${method} sera bientôt disponible!`, 'info');
        }

        getCustomerInfo() {
            return {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                postalCode: document.getElementById('postalCode').value,
                country: document.getElementById('country').value
            };
        }

        clearCartAndRedirect(orderId, method) {
            // Limpiar carrito
            this.cartService.clearCart();
            
            // Redirigir a página de confirmación
            setTimeout(() => {
                window.location.href = `order-confirmation.html?order_id=${orderId}&method=${method}`;
            }, 2000);
        }

        showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    }

    // Inicializar el sistema cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
        new CheckoutSystem();
    });
</script>
</body>
</html>
